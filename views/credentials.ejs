<%- include('./components/wrapper', { title: 'Credentials'}) %>
<main class="min-h-screen bg-gray-900">
  <div class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Your Credentials üîê</h1>
        <p class="mt-2 text-gray-400">Find all your login credentials to access your servers here.</p>
      </div>

      <!-- Pterodactyl Credentials Card -->
      <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700 mb-6">
        <div class="p-6">
          <div class="flex items-center mb-4">
            <div class="bg-purple-500/10 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
            </div>
            <h2 class="ml-4 text-xl font-semibold text-white">Panel Credentials</h2>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div class="bg-gray-700/50 rounded-lg p-4">
              <p class="text-sm font-medium text-gray-400 mb-2">Email</p>
              <div class="flex items-center justify-between">
                <code class="text-sm text-white bg-gray-800 px-2 py-1 rounded"><%= user.email %></code>
                <button onclick="copyToClipboard('<%= user.email %>')" class="text-gray-400 hover:text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>

            <div class="bg-gray-700/50 rounded-lg p-4">
              <p class="text-sm font-medium text-gray-400 mb-2">Panel URL</p>
              <div class="flex items-center justify-between">
                <code class="text-sm text-white bg-gray-800 px-2 py-1 rounded"><%= url %></code>
                <button onclick="copyToClipboard('<%= url %>')" class="text-gray-400 hover:text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>

            <div id="new-password-container" class="mt-4"></div>
          </div>

          <div class="mt-6 flex justify-center space-x-4">
            <a href="/autologin" 
               class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-purple-600 hover:bg-purple-500 transition-all duration-200 transform hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Auto Login to Panel
            </a>

            <button id="reset-password-btn"
               onclick="resetPassword()"
               class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-red-600 hover:bg-red-500 transition-all duration-200 transform hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
              Reset Password
            </button>


            <button onclick="confirmDelete()"
               class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-red-800 hover:bg-red-700 transition-all duration-200 transform hover:scale-105">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Delete Account
            </button>
          </div>

          <div class="mt-4 text-sm text-gray-400">
            <p>‚ö†Ô∏è For security reasons, your password is not displayed. If you forgot it, please use the reset function on the panel.</p>
          </div>
        </div>
      </div>

      <!-- Server Credentials List -->
      <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
        <div class="px-6 py-4 border-b border-gray-700">
          <h3 class="text-lg font-medium text-white">Server Credentials</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-900">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Server Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">IP:Port</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">SFTP</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700">
              <% if (servers.length === 0) { %>
                <tr>
                  <td colspan="4" class="px-6 py-8 text-center text-gray-400">
                    No servers found
                  </td>
                </tr>
              <% } else { %>
                <% for (let server of servers) { %>
                  <tr class="hover:bg-gray-700/50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                      <%= server.attributes.name %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                      <code class="bg-gray-900 px-2 py-1 rounded">
                        <% if (serversDetails.attributes && serversDetails.attributes.relationships && 
                               serversDetails.attributes.relationships.allocations && 
                               serversDetails.attributes.relationships.allocations.data[0]) { %>
                          <%= serversDetails.attributes.relationships.allocations.data[0].attributes.ip %>:<%= serversDetails.attributes.relationships.allocations.data[0].attributes.port %>
                        <% } else { %>
                          IP not available
                        <% } %>
                      </code>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                      <code class="bg-gray-900 px-2 py-1 rounded">
                        <% if (serversDetails.attributes && serversDetails.attributes.sftp_details && serversDetails.attributes.sftp_details.ip && serversDetails.attributes.sftp_details.port) { %>
                          sftp://<%= serversDetails.attributes.sftp_details.ip %>:<%= serversDetails.attributes.sftp_details.port %>
                        <% } else { %>
                          SFTP not available
                        <% } %>
                      </code>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                      <% if (serversDetails.attributes && serversDetails.attributes.relationships && 
                             serversDetails.attributes.relationships.allocations && 
                             serversDetails.attributes.relationships.allocations.data[0]) { %>
                        <button onclick="copyToClipboard('<%= serversDetails.attributes.relationships.allocations.data[0].attributes.ip %>:<%= serversDetails.attributes.relationships.allocations.data[0].attributes.port %>')" 
                                class="text-blue-400 hover:text-blue-300">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </button>
                      <% } %>
                    </td>
                  </tr>
                <% } %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('Copied to clipboard');
  });
}

function confirmDelete() {
  if (confirm('Are you sure you want to delete your account? This action is irreversible.')) {
    window.location.href = '/auth/delete-account';
  }
}

async function resetPassword() {
  const button = document.getElementById('reset-password-btn');
  button.disabled = true;
  button.innerText = 'Resetting...';

  try {
    const response = await fetch('/auth/reset-password', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
    });

    const data = await response.json();

    if (response.status === 200 && data.success) {
      alert('Your new password is: ' + data.newPassword	);

      const passwordDiv = document.getElementById('new-password-container');
      passwordDiv.innerHTML = `
        <div class="bg-gray-700/50 rounded-lg p-4">
          <label class="block text-sm font-medium text-gray-400">New Password</label>
          <div class="mt-1 p-2 bg-gray-800 rounded-md font-mono">
            <p class="text-sm text-white">${data.newPassword	}</p>
          </div>
          <p class="mt-1 text-sm text-red-600">Please save this password securely!</p>
        </div>
      `;
    } else {
      alert('Failed to reset password. Please try again later.');
    }
  } catch (error) {
    alert('An error occurred while resetting the password.');
  }

  button.disabled = false;
  button.innerText = 'Reset Password';
}
</script>

<%- include('./components/footer') %>