<%- include('./components/wrapper', { title: 'Servers Management'}) %>
<main class="min-h-screen bg-gray-900">
  <div class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-white tracking-tight">üëã Welcome to Server Management</h1>
          <p class="mt-2 text-gray-400">Manage your game servers and applications with ease</p>
        </div>
        <a href="../create-server" class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-500 transition-all duration-200 transform hover:scale-105">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          New Server
        </a>
      </div>

      <div class="mb-6 bg-amber-500/20 border border-amber-500/30 rounded-lg p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-amber-400">Important - First Launch</h3>
            <div class="mt-2 text-sm text-amber-300">
              <p>
                When starting your server for the first time, you'll need to connect to the dashboard to accept the EULA (End User License Agreement). Your server won't start properly without completing this step.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <% if (servers && servers.length > 0) { %>
          <% for (let server of servers) { %>
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl shadow-xl overflow-hidden border border-slate-700/50 hover:border-emerald-500/50 transition-all duration-300 hover:transform hover:scale-[1.02] flex flex-col">
              <div class="px-6 py-5 border-b border-slate-700/50">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h3 class="text-xl font-medium text-white truncate"><%= server.name || "Nom inconnu" %></h3>
                    <p class="mt-1 text-sm text-slate-400">ID: <%= server.identifier %></p>
                  </div>
                  
                  <span id="serverStatus" 
                  class="px-4 py-1.5 text-sm font-medium rounded-full shadow-inner ml-4
                    <%= server.status === 'running' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 
                       server.status === 'starting' ? 'bg-emerald-500/20 text-yellow-500 border border-yellow-500/30' :
                       server.status === 'offline' ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 
                       'bg-slate-500/20 text-slate-400 border border-slate-500/30' %>">
                    <%= server.status || 'unknown' %>
                  </span>
                  <script>
                    setInterval(() => getStatus('<%= server.identifier %>'), 15000);
                    async function getStatus(identifier) {
                      try {
                        const response = await fetch(`/api/server/${identifier}/status`, {
                          method: 'GET'
                        });

                        if (!response.ok) throw new Error('Failed to get server status');

                        const data = await response.json();

                        if (data.status === 'running') {
                          document.getElementById(`serverStatus`).classList.remove('bg-red-500/20', 'text-red-400', 'border', 'border-red-500/30');
                          document.getElementById(`serverStatus`).classList.add('bg-emerald-500/20', 'text-emerald-400', 'border', 'border-emerald-500/30');
                        } else if (data.status === 'starting') {
                          document.getElementById(`serverStatus`).classList.remove('bg-red-500/20', 'text-red-400', 'border', 'border-red-500/30');
                          document.getElementById(`serverStatus`).classList.add('bg-yellow-500/20', 'text-yellow-500', 'border', 'border-yellow-500/30');
                        } else if (data.status === 'offline') {
                          document.getElementById(`serverStatus`).classList.remove('bg-emerald-500/20', 'text-emerald-400', 'border', 'border-emerald-500/30');
                          document.getElementById(`serverStatus`).classList.add('bg-red-500/20', 'text-red-400', 'border', 'border-red-500/30');
                        } else {
                          document.getElementById(`serverStatus`).classList.remove('bg-emerald-500/20', 'text-emerald-400', 'border', 'border-emerald-500/30');
                          document.getElementById(`serverStatus`).classList.add('bg-slate-500/20', 'text-slate-400', 'border', 'border-slate-500/30');
                        }
                        document.getElementById(`serverStatus`).textContent = data.status;
                      } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to get server status. Please try again.');
                      }
                    }
                  </script>
                </div>
              </div>

              <div class="px-6 py-6 flex-1">
                <dl class="grid grid-cols-1 gap-6">

                  <div class="grid grid-cols-2 gap-4 mt-2">
                    <div class="bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/40 transition-all duration-300">
                      <dt class="text-sm font-medium text-slate-400">üåê IP Address</dt>
                      <dd class="mt-1 text-sm text-slate-300">
                        <%= server.allocationDetails.allocations.data[0].attributes.ip %>:<%= server.allocationDetails.allocations.data[0].attributes.port || 'Port non disponible' %>
                      </dd>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/40 transition-all duration-300">
                      <dt class="text-sm font-medium text-slate-400">üìç Location</dt>
                      <dd class="mt-1 text-sm text-slate-300">
                        <%= server.locations || 'Location non disponible' %>
                      </dd>
                    </div>
                  </div>
                </dl>
              </div>

              <div class="px-6 py-4 bg-slate-800/30 border-t border-slate-700/50">
                <div class="flex justify-between space-x-3">
                  <div class="flex space-x-3">
                    <button onclick="controlServer('<%= server.identifier %>', 'start')" 
                            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-emerald-400 bg-emerald-500/10 hover:bg-emerald-500 hover:text-white transition-all duration-200">
                      <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                      </svg>
                      Start
                    </button>
                    <button onclick="controlServer('<%= server.identifier %>', 'restart')" 
                            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-amber-400 bg-amber-500/10 hover:bg-amber-500 hover:text-white transition-all duration-200">
                      <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      Restart
                    </button>
                    <button onclick="controlServer('<%= server.identifier %>', 'stop')" 
                            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-red-400 bg-red-500/10 hover:bg-red-500 hover:text-white transition-all duration-200">
                      <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                      </svg>
                      Stop
                    </button>
                  </div>
                  <div class="flex space-x-2">
                    <a href="/panel" 
                       class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-cyan-400 bg-cyan-500/10 hover:bg-cyan-500 hover:text-white transition-all duration-200">
                      Console
                    </a>
                    <button onclick="deleteServer('<%= server.id %>')" 
                            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-red-400 bg-red-500/10 hover:bg-red-500 hover:text-white transition-all duration-200">
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% } %>
        <% } else { %>
          <div class="col-span-full text-center py-12">
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-8 max-w-md mx-auto">
              <svg class="mx-auto h-12 w-12 text-slate-400 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
              </svg>
              <h3 class="mt-4 text-lg font-medium text-white">No servers yet! üöÄ</h3>
              <p class="mt-2 text-slate-400">Let's create your first server and get started on your journey!</p>
              <div class="mt-6">
                <a href="../create-server" class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-500 transition-all duration-200 transform hover:scale-105">
                  <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  New Server
                </a>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<script>
async function controlServer(identifier, action) {
  try {
    const response = await fetch(`/api/server/${identifier}/${action}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) throw new Error('Failed to control server');
    
    location.reload();
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to perform action. Please try again.');
  }
}

async function deleteServer(id) {
  if (!confirm('Are you sure you want to delete this server? This action cannot be undone.')) return;
  
  try {
    const response = await fetch(`/delete-server/${id}`, {
      method: 'GET'
    });
    
    if (!response.ok) throw new Error('Failed to delete server');
    
    location.reload();
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to delete server. Please try again.');
  }
}
</script>

<%- include('./components/footer') %>