<%- include('../components/wrapper', { title: `Server Control` }) %>
    <main class="min-h-screen py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-12 gap-6">
                <!-- Left Column - Pterodactyl Server Info -->
                <div class="col-span-12 lg:col-span-4 space-y-6">
                    <div class="bg-slate-800/70 backdrop-blur-sm rounded-2xl border border-purple-500 shadow-2xl overflow-hidden">
                        <div class="px-6 py-5 bg-purple-500/10 border-b border-purple-500">
                            <div class="flex items-center justify-between">
                                <h1 class="text-2xl font-bold text-purple-300 truncate flex items-center">
                                    <svg class="w-8 h-8 mr-3 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zm0 12l-10-5 10 5 10-5v7l-10 5z"/>
                                    </svg>
                                    <%= serverId %>
                                </h1>
                                <span class="px-3 py-1 text-sm font-medium rounded-full bg-purple-500/20 text-purple-300 border border-purple-500">
                                    Active
                                </span>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Resource Stats with Pterodactyl-style Icons -->
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                        <span class="text-sm text-slate-400">CPU Usage</span>
                                    </div>
                                    <span class="text-sm font-medium text-purple-300"><%= resources.cpu %>%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                                        </svg>
                                        <span class="text-sm text-slate-400">Memory</span>
                                    </div>
                                    <span class="text-sm font-medium text-purple-300"><%= resources.ram %> MB</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span class="text-sm text-slate-400">Disk</span>
                                    </div>
                                    <span class="text-sm font-medium text-purple-300"><%= resources.disk %> GB</span>
                                </div>
                            </div>

                            <!-- Control Buttons with Pterodactyl-inspired Design -->
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <button id="startServer" class="flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium text-green-400 bg-green-500/10 hover:bg-green-500 hover:text-white border border-green-500/30 transition-all duration-200">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Start Server
                                </button>
                                <button id="restartServer" class="flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium text-red-400 bg-red-500/10 hover:bg-red-500 hover:text-white border border-red-500/30 transition-all duration-200">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                                    </svg>
                                    Restart Server
                                </button>
                                <button id="stopServer" class="flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium text-red-400 bg-red-500/10 hover:bg-red-500 hover:text-white border border-red-500/30 transition-all duration-200">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                                    </svg>
                                    Stop Server
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Console -->
                <div class="col-span-12 lg:col-span-8">
                    <div class="bg-slate-800/70 backdrop-blur-sm rounded-2xl border border-purple-500 shadow-2xl overflow-hidden h-full">
                        <div class="px-6 py-4 bg-purple-500/10 border-b border-purple-500 flex items-center justify-between">
                            <h2 class="text-lg font-medium text-purple-300 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Console
                            </h2>
                            <div class="flex space-x-2">
                                <button class="p-1.5 rounded-lg text-purple-400 hover:text-white hover:bg-purple-500/20 transition-all duration-200">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button class="p-1.5 rounded-lg text-purple-400 hover:text-white hover:bg-purple-500/20 transition-all duration-200">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="consoleOutput" class="bg-slate-900/80 text-white font-mono text-sm p-4 rounded-lg h-[calc(100vh-24rem)] overflow-y-auto border border-purple-500/20"></div>
                            <div class="mt-4">
                                <input type="text" class="w-full bg-slate-900/80 text-white font-mono text-sm p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/50" placeholder="Enter a command..." id="consoleInput">
                                <button class="p-2 rounded-lg bg-purple-500/10 text-white hover:bg-purple-500 hover:text-white transition-all duration-200" onclick="sendCommand()">
                                    Send Command
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const serverId = "<%= serverId %>";
        const userId = "<%= user.id %>";
        
        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/serverws`);
        
        ws.onopen = () => {
            console.log('WebSocket connected');
            ws.send(JSON.stringify({ userId, serverId }));
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                
                if (message.event === 'console output') {
                    const consoleOutput = message.args[0];
                    const consoleDiv = document.getElementById('consoleOutput');
                    consoleDiv.innerText += consoleOutput + '\n';
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error processing WebSocket message:', error);
            }
        };

        ws.onclose = () => console.log('WebSocket closed');
        ws.onerror = (error) => console.error('WebSocket error:', error);

        document.getElementById("startServer").onclick = async ()  => {
            const response = await fetch(`/api/server/<%= serverId %>/start`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) throw new Error('Failed to control server');
        };

        document.getElementById("restartServer").onclick = async () => {
            const response = await fetch(`/api/server/<%= serverId %>/restart`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) throw new Error('Failed to control server');
        };

        document.getElementById("stopServer").onclick = async () => {
            const response = await fetch(`/api/server/<%= serverId %>/stop`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) throw new Error('Failed to control server');
        };

        document.getElementById('consoleInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const command = this.value;
                console.log("Sending command:", command);
                sendWebSocketCommand(command);
                this.value = '';
            }
        });

        function sendWebSocketCommand(command) {
            if (!command) return;
                
            ws.send(JSON.stringify({
                event: "send command",
                command: command,
                userId: userId,
                serverId: serverId
            }));
        }

        
    </script>

    <%- include('../components/footer') %>